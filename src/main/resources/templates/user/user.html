<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/css/userinfo.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/common/custom.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/css/user.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/css/fancybox.min.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/fontawesome/css/fontawesome.min.css}" media="all"/>
    <script th:src="@{/static/layui/layui.js}"></script>
    <script th:src="@{/static/js/search.js}"></script>
    <script th:src="@{/static/common/jquery.min.js}"></script>
    <script th:src="@{/static/js/forum.js}"></script>
    <script th:src="@{/static/js/fancybox.min.js}"></script>
</head>
<body>
<div class="layui-layout layui-layout-admin">
    <header th:replace="common/header"></header>

    <div id="user-index-body" style="margin-left: 33%;margin-top: 2%">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-index-header"></div>
        <!-- å¯¼èˆªæ  -->
        <div class="layui-tab layui-tab-brief" lay-filter="userIndex" style="margin: 10px 500px 0 0;">
            <ul class="layui-tab-title">
                <li class="layui-this" id="myQuestionsTab">ğŸ™‹â€â™‚æˆ‘çš„å¸–å­</li>
                <li id="myCommentsTab">ğŸ’¬ æˆ‘çš„è¯„è®º</li>
                <li id="myCollectionTab">ğŸ·ï¸ æˆ‘çš„æ”¶è—</li>
                <li>ğŸ”¥ çƒ­é—¨é—®é¢˜</li>
            </ul>
            <div class="layui-tab-content" style="height: 100px;">
                <!-- æˆ‘çš„é—®é¢˜ -->
                <div class="layui-tab-item layui-show" id="myQuestions"></div>
                <!-- æˆ‘çš„å›å¤ -->
                <div class="layui-tab-item" id="myComments"></div>
                <!-- æˆ‘çš„æ”¶è— -->
                <div class="layui-tab-item" id="myCollection"></div>
                <!-- æœ€çƒ­é—®é¢˜ -->
                <div class="layui-tab-item" id="myHotQuestions"></div>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">

    let loginUserInfo = [[${session.loginUserInfo}]];
    init(loginUserInfo);

    layui.use(['element', 'form', 'jquery', 'flow'], function () {
        let element = layui.element;
        let $ = layui.jquery;
        let flow = layui.flow;

        //é¢åŒ…å±‘ä½¿ç”¨
        let currPoisition = "<span lay-separator=\"\">&gt;</span><a><cite>ç”¨æˆ·ä¸»é¡µ</cite></a>";
        $(".layui-breadcrumb a").last().after(currPoisition);

        $("#title-user").addClass("layui-this");

        //è·å–userçš„ä¸ªäººä¿¡æ¯
        let username = [[${username}]];

        //ç›‘å¬é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶ï¼ŒæµåŠ è½½ä¿¡æ¯
        element.on('tab(userIndex)', function (data) {
            if (data.index === 0) {
                //è·å–æˆ‘çš„é—®é¢˜è¯¦æƒ…
                flow.load({
                    elem: '#myQuestions',
                    isAuto: false,
                    end: '<div style="font-size: 16px;color: #999;margin-bottom: 50px">åˆ°åº•äº†ï¼Œå·²ç»æ²¡æœ‰æ›´å¤šå¯ä»¥å±•ç¤ºäº†</div>',
                    done: function (page, next) {
                        let lis = ["<div id='questions'><ul class='question-list'>"];
                        let html = "";
                        $.get('/getMyQuestions?username=' + username + '&page=' + page, function (res) {
                            if (res.status === 200) {
                                if (res.data === null) {
                                    // lis.push("<div style='font-size: 20px;font-weight: 300;'>æš‚æ— æ”¶è—æ¶ˆæ¯</div>");
                                    lis.push("");
                                } else {
                                    layui.each(res.data, function (i, item) {
                                        html = "                       <li>\n" +
                                            "                                <div class=\"content\">\n" +
                                            "                                    <a class=\"title\" target=\"_blank\" href=\"/question/" + item.id + "\">" + item.title + "</a>\n" +
                                            "                                    <p class=\"abstract\">" + item.description + "</p>\n" +
                                            "                                    <div class=\"meta\">\n" +
                                            "                                        <a target=\"_blank\" href=\"#\">\n" +
                                            "                                            <i class=\"fa fa-eye\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.viewCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </a>\n" +
                                            "                                        <span><i class=\"fa fa-comments\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.commentCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </span>\n" +
                                            "                                        <a target=\"_blank\" href=\"#\">\n" +
                                            "                                            <i class=\"fa fa-heart\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.likeCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </a>\n" +
                                            "                                        <span class=\"time\">\n" +
                                            "                                            <i class=\"fa fa-clock-o\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span> " + item.gmtCreate + "</span>\n" +
                                            "                                        </span>\n" +
                                            "                                    </div>\n" +
                                            "                                </div>\n" +
                                            "                            </li>";
                                        lis.push(html);
                                    });
                                }
                            }
                            next(lis.join(''), page < res.pages);
                            lis.push("</ul></div>");
                        });
                    }
                });
            } else if (data.index === 1) {
                //æˆ‘çš„è¯„è®ºä¿¡æ¯
                flow.load({
                    elem: '#myComments',
                    isAuto: false,
                    end: '<div style="font-size: 16px;color: #999;margin-bottom: 50px">åˆ°åº•äº†ï¼Œå·²ç»æ²¡æœ‰æ›´å¤šå¯ä»¥å±•ç¤ºäº†</div>',
                    done: function (page, next) {
                        let lis = ["<div id='comments'><ul class='comment-list'>"];
                        let html = "";
                        $.get('/getMyCommentInfo?username=' + username + '&page=' + page, function (res) {
                            if (res.status === 200) {
                                if (res.data === null) {
                                    // lis.push("<div style='font-size: 20px;font-weight: 300;'>æš‚æ— æ”¶è—æ¶ˆæ¯</div>");
                                    lis.push("");
                                } else {
                                    layui.each(res.data, function (i, item) {
                                        html = "                     <li>\n" +
                                            "                                <div class=\"content\">\n" +
                                            "                                    <div class=\"author\">\n" +
                                            "                                        <a class=\"avatar\" href=\"#\">\n" +
                                            "                                            <img style=\"width: 30px;height: 30px;border-radius: 50%\"\n" +
                                            "                                                 src=\"" + item.avatar + "\"\n" +
                                            "                                                 alt=\"180\">\n" +
                                            "                                        </a>\n" +
                                            "                                        <div class=\"info\">\n" +
                                            "                                            <a class=\"nickname\" href=\"#\">" + item.username + "</a>\n" +
                                            "                                            <span data-type=\"share_note\" data-datetime=\"2019-06-11T16:56:18+08:00\"> å‘è¡¨äº†è¯„è®º Â· " + item.time + "</span>\n" +
                                            "                                        </div>\n" +
                                            "                                    </div>\n" +
                                            "                                    <p class=\"comment\" style=\"margin-bottom: 10px;\">" + item.comment + "</p>\n" +
                                            "                                    <blockquote>\n" +
                                            "                                        <a class=\"title\" href=\"/question/" + item.questionId + "\">" + item.title + "</a>\n" +
                                            "                                        <p class=\"abstract\">" + item.contents + "</p>\n" +
                                            "                                        <div class=\"meta\" style=\"font-size: 12px\">\n" +
                                            "                                            <a target=\"_blank\" href=\"#\">\n" +
                                            "                                                <i class=\"fa fa-eye\" aria-hidden=\"true\"></i>\n" +
                                            "                                                <span>" + item.viewCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                            </a>\n" +
                                            "                                            <span><i class=\"fa fa-comments\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.commentCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </span>\n" +
                                            "                                            <a target=\"_blank\" href=\"#\">\n" +
                                            "                                                <i class=\"fa fa-heart\" aria-hidden=\"true\"></i>\n" +
                                            "                                                <span>" + item.likeCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                            </a>\n" +
                                            "                                        </div>\n" +
                                            "                                    </blockquote>\n" +
                                            "                                </div>\n" +
                                            "                            </li>";
                                        lis.push(html);
                                    });
                                }
                            }
                            next(lis.join(''), page < res.pages);
                            lis.push("</ul></div>");
                        });
                    }
                });
            } else if (data.index === 2) {
                //æˆ‘çš„æ”¶è—
                flow.load({
                    elem: '#myCollection',
                    isAuto: false,
                    end: '<div style="font-size: 16px;color: #999;margin-bottom: 50px">åˆ°åº•äº†ï¼Œå·²ç»æ²¡æœ‰æ›´å¤šå¯ä»¥å±•ç¤ºäº†</div>',
                    done: function (page, next) {
                        let lis = ["<div id='collection'><ul class='collection-list'>"];
                        let html = "";
                        $.get('/getMyCollection?username=' + username + '&page=' + page, function (res) {
                            if (res.status === 200) {
                                if (res.data === null) {
                                    // lis.push("<div style='font-size: 20px;font-weight: 300;'>æš‚æ— æ”¶è—æ¶ˆæ¯</div>");
                                    lis.push("");
                                } else {
                                    layui.each(res.data, function (i, item) {
                                        html = "<li>\n" +
                                            "          <div class=\"content\">\n" +
                                            "               <a class=\"title\" target=\"_blank\" href=\"/question/" + item.id + "\">" + item.title + "</a>\n" +
                                            "                    <p class=\"abstract\">" + item.description + "</p>\n" +
                                            "                     <div class=\"meta\">\n" +
                                            "                          <a target=\"_blank\" href=\"#\">\n" +
                                            "                               <i class=\"fa fa-eye\" aria-hidden=\"true\"></i>\n" +
                                            "                                    <span>" + item.viewCount + "&nbsp;&nbsp;</span>\n" +
                                            "                          </a>\n" +
                                            "                          <span><i class=\"fa fa-comments\" aria-hidden=\"true\"></i>\n" +
                                            "                          <span>" + item.commentCount + "&nbsp;&nbsp;</span>\n" +
                                            "                          </span>\n" +
                                            "                          <a target=\"_blank\" href=\"#\">\n" +
                                            "                               <i class=\"fa fa-heart\" aria-hidden=\"true\"></i>\n" +
                                            "                                   <span>" + item.likeCount + "&nbsp;&nbsp;</span>\n" +
                                            "                               </a>\n" +
                                            "                          <span class=\"time\" data-shared-at=\"2019-07-15T14:24:48+08:00\">\n" +
                                            "                                 <i class=\"fa fa-clock-o\" aria-hidden=\"true\"></i>\n" +
                                            "                                  <span> " + item.gmtCreate + "</span>\n" +
                                            "                            </span>\n" +
                                            "                   </div>\n" +
                                            "          </div>\n" +
                                            "     </li>";
                                        lis.push(html);
                                    });
                                }
                            }
                            next(lis.join(''), page < res.pages);
                            lis.push("</ul></div>");
                        });
                    }
                });
            } else if (data.index === 3) {
                //æˆ‘çš„çƒ­é—¨
                flow.load({
                    elem: '#myHotQuestions',
                    isAuto: false,
                    end: '<div style="font-size: 16px;color: #999;margin-bottom: 50px">åˆ°åº•äº†ï¼Œå·²ç»æ²¡æœ‰æ›´å¤šå¯ä»¥å±•ç¤ºäº†</div>',
                    done: function (page, next) {
                        let lis = ["<div id='hotQuestion'><ul class='hotQuestion-list'>"];
                        let html = "";
                        $.get('/getMyHotQuestions?username=' + username + '&page=' + page, function (res) {
                            if (res.status === 200) {
                                if (res.data === null) {
                                    // lis.push("<div style='font-size: 20px;font-weight: 300;'>æš‚æ— æ”¶è—æ¶ˆæ¯</div>");
                                    lis.push("");
                                } else {
                                    layui.each(res.data, function (i, item) {
                                        html = "                       <li>\n" +
                                            "                                <div class=\"content\">\n" +
                                            "                                    <a class=\"title\" target=\"_blank\" href=\"/question/" + item.id + "\">" + item.title + "</a>\n" +
                                            "                                    <p class=\"abstract\">" + item.description + "</p>\n" +
                                            "                                    <div class=\"meta\">\n" +
                                            "                                        <a target=\"_blank\" href=\"#\">\n" +
                                            "                                            <i class=\"fa fa-eye\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.viewCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </a>\n" +
                                            "                                        <span><i class=\"fa fa-comments\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.commentCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </span>\n" +
                                            "                                        <a target=\"_blank\" href=\"#\">\n" +
                                            "                                            <i class=\"fa fa-heart\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span>" + item.likeCount + "&nbsp;&nbsp;</span>\n" +
                                            "                                        </a>\n" +
                                            "                                        <span class=\"time\" data-shared-at=\"2019-07-15T14:24:48+08:00\">\n" +
                                            "                                            <i class=\"fa fa-clock-o\" aria-hidden=\"true\"></i>\n" +
                                            "                                            <span> " + item.gmtCreate + "</span>\n" +
                                            "                                        </span>\n" +
                                            "                                    </div>\n" +
                                            "                                </div>\n" +
                                            "                            </li>";
                                        lis.push(html);
                                    });
                                }
                            }
                            next(lis.join(''), page < res.pages);
                            lis.push("</ul></div>");
                        });
                    }
                });
            }
        });

        //é€‰ä¸­
        $('.layui-header li').click(function () {
            $(this).addClass('layui-this').siblings().removeClass('layui-this');
        });


        $("#myQuestionsTab").click();

    });

    //é¡µé¢åŠ è½½å®Œæˆå°±å¼€å§‹
    $(document).ready(function () {
        let username = loginUserInfo.username;  //ç™»å½•ç”¨æˆ·å

        if (($.trim(username).length > 0)) {
            //è·å–æˆ‘çš„è¯¦æƒ…é¡µé¢
            let queryUsername = [[${username}]];  //æŸ¥è¯¢çš„ç”¨æˆ·å
            if (username !== queryUsername) {
                //å½“å‰ç™»å½•ç”¨æˆ·å’ŒæŸ¥è¯¢ç”¨æˆ·ä¸åŒ
                $("#myQuestionsTab").html("ğŸ™‹â€â™‚Taçš„å¸–å­");
                $("#myCommentsTab").html("ğŸ’¬ Taçš„è¯„è®º");
                $("#myCollectionTab").html("ğŸ·ï¸ Taçš„æ”¶è—");
            }

            $.ajax({
                type: "get",
                url: "/getUserIndexInfo",
                async: false,
                data: {username: queryUsername},
                success: function (res) {
                    let html = "";
                    if (res.status === 200) {
                        let userInfo = res.data;
                        let sexHtml = "";
                        if (userInfo.sex === '1') {
                            sexHtml = "<i class=\"layui-icon layui-icon-male\"></i>";
                        } else if (userInfo.sex === '2') {
                            sexHtml = "<i class=\"layui-icon layui-icon-female\"></i>";
                        }
                        html += "            <div>\n" +
                            "                <a data-fancybox=\"gallery\" class=\"index-useravatar wrapper\" href='" + userInfo.avatar + "'>\n" +
                            "                    <img style=\"border-radius: 10px\" width=\"80\" height=\"80\"\n" +
                            "                         src=\"" + userInfo.avatar + "\"\n" +
                            "                         id=\"no-view\">" + sexHtml + "\n" +
                            "                </a>\n" +
                            "                <span class=\"index-username\">" + queryUsername + "</span>" +
                            "                     <span class='focus-links' style='margin-left: 20px;vertical-align: 6px;display: none;'>å…³æ³¨</span>\n" +
                            "                <div class=\"user-info\" style=\"margin-left: 103px\">\n" +
                            "                    <ul style=\"margin-top: 10px\">\n" +
                            "                        <li>\n" +
                            "                            <div class=\"meta-block\" style='cursor: pointer;'><a onclick='getFollow()'><p>" + userInfo.follow + "</p><span>å…³æ³¨ ></span></a></div>\n" +
                            "                        </li>\n" +
                            "                        <li>\n" +
                            "                            <div class=\"meta-block\" style='cursor: pointer;'><a onclick='getFans()'><p>" + userInfo.fans + "</p><span>ç²‰ä¸ ></span></a></div>\n" +
                            "                        </li>\n" +
                            "                        <li>\n" +
                            "                            <div class=\"meta-block\"><p>" + userInfo.questionNum + "</p><span>å¸–å­</span></div>\n" +
                            "                        </li>\n" +
                            "                        <li>\n" +
                            "                            <div class=\"meta-block\"><p>" + userInfo.likeCount + "</p><span>è·èµ</span></div>\n" +
                            "                        </li>\n" +
                            "                        <li>\n" +
                            "                            <div class=\"meta-block\" style=\"border-right: none\"><p>" + userInfo.rate + "</p><span>ç§¯åˆ†</span></div>\n" +
                            "                        </li>\n" +
                            "                    </ul>\n" +
                            "                </div>\n" +
                            "            </div>";

                        $(".user-index-header").html(html);

                        //åˆ¤æ–­æ˜¯å¦æœ‰å…³æ³¨æŒ‰é’®
                        if (username !== queryUsername) {
                            //å­˜åœ¨å…³æ³¨æŒ‰é’®
                            $(".focus-links").show();

                            //æŸ¥è¯¢æ˜¯å¦å…³ç³»ä¿¡æ¯
                            $.ajax({
                                type: "get",
                                url: "/getFollowStatus",
                                data: {
                                    userName: queryUsername,
                                    followName: username
                                },
                                async: false,
                                success: function (res) {
                                    if (res.status === 200) {
                                        if (res.data === 1) {
                                            //å·²å…³æ³¨
                                            $(".focus-links").css("background-color", "#a9b5ac");
                                            $(".focus-links").html("å·²å…³æ³¨");
                                        } else {
                                            //æœªå…³æ³¨
                                            $(".focus-links").css("background-color", "#42c02e");
                                            $(".focus-links").html("<i class=\"fa fa-plus\" aria-hidden=\"true\"></i>&nbsp;å…³æ³¨");
                                        }
                                    }
                                }
                            });
                        } else {
                            $(".focus-links").hide();
                        }

                        //å…³æ³¨æŒ‰é’®
                        $(".focus-links").click(function () {
                            $.ajax({
                                type: "get",
                                url: "/follow",
                                async: false,
                                data: {
                                    userName: queryUsername,   //è¢«å…³æ³¨çš„ç”¨æˆ·å
                                    followName: username   //ç‚¹å‡»å…³æ³¨è€…çš„ç”¨æˆ·å
                                },
                                success: function (res) {
                                    if (res.status === 200) {
                                        if (res.data === 0) {
                                            //å–æ¶ˆå…³æ³¨
                                            $(".focus-links").css("background-color", "#42c02e");
                                            $(".focus-links").html("å…³æ³¨");
                                        } else {
                                            //å…³æ³¨å
                                            $(".focus-links").css("background-color", "#a9b5ac");
                                            $(".focus-links").html("å·²å…³æ³¨");
                                        }
                                    }
                                }
                            })
                        })

                    }
                }
            });
        }
    });

    function getFollow() {
        let username = loginUserInfo.username;
        let queryUsername = [[${username}]];
        if (username === queryUsername) {
            window.location.href = "/myfollow?choose=follow";
        }
    }

    function getFans() {
        let username = loginUserInfo.username;
        let queryUsername = [[${username}]];
        if (username === queryUsername) {
            window.location.href = "/myfollow?choose=fans";
        }
    }

</script>
</body>
</html>